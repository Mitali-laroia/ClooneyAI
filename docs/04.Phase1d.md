# Phase 1d: Intelligent Retry Logic & CSS Context Enhancement

**Status:** ‚úÖ Completed
**Date:** 2025-11-15
**Goal:** Implement intelligent retry mechanism for failed selectors and enhance AI context with CSS information

---

## Overview

Phase 1d adds two critical enhancements to the AI-guided login system:

1. **Intelligent Retry Logic**: When a selector fails, the system automatically retries with OpenAI feedback instead of immediately failing
2. **CSS Context Integration**: Include page CSS in OpenAI calls for better selector identification

These features work together to significantly improve login success rates and selector accuracy.

---

## Problem Statement

### Issues Identified

1. **Invalid Selectors**: OpenAI sometimes suggested jQuery-style selectors like `button:contains('Continue')` which are invalid in standard CSS
2. **Immediate Failures**: The system failed immediately on first error without attempting alternatives
3. **Limited Context**: OpenAI only saw HTML, missing CSS class names and style information
4. **No Learning**: System couldn't learn from previous selector failures

### Example Failure

```
============================================================
üîÑ Iteration 2/10 - Step: click_email_continue
============================================================
üñ±Ô∏è  Clicking Continue button after email...
   Clicking continue button: button:contains('Continue')
‚ùå Click failed: Page.click: SyntaxError: Failed to execute 'querySelectorAll' on 'Document':
'button:contains("Continue")' is not a valid selector.

‚ùå Login failed
```

---

## Solution Architecture

### 1. Intelligent Retry Mechanism

#### State Extensions

Added retry tracking to `CloneState`:

```python
class CloneState(TypedDict):
    # ... existing fields ...

    # Retry fields
    last_error: str | None  # Last error message for AI to learn from
    step_retry_count: int   # Number of retries for current step (max 3)
```

#### Retry Flow

```
Action Step (e.g., click_email_continue)
    ‚Üì
Try selector from AI
    ‚Üì
Success? ‚îÄ‚îÄYes‚îÄ‚îÄ‚Üí Continue to next step (reset retry count)
    ‚Üì
    No
    ‚Üì
Retry count < 3? ‚îÄ‚îÄNo‚îÄ‚îÄ‚Üí FAIL (max retries exhausted)
    ‚Üì
   Yes
    ‚Üì
Go back to AI step (e.g., find_email_continue)
    ‚Üì
Pass error message to OpenAI
    ‚Üì
OpenAI suggests DIFFERENT selector
    ‚Üì
Try again (increment retry count)
```

#### Implementation Example

**Before (Phase 1b):**
```python
try:
    await page.click(selector, timeout=5000)
except Exception as e:
    return {
        **state,
        "current_step": "failed",
        "error": f"Failed to click: {str(e)}",
    }
```

**After (Phase 1d):**
```python
try:
    await page.click(selector, timeout=5000)
except Exception as e:
    error_msg = str(e)
    retry_count = state.get("step_retry_count", 0)

    # Retry with AI if under retry limit
    if retry_count < 3:
        print(f"üîÑ Retrying... (attempt {retry_count + 1}/3)")
        return {
            **state,
            "current_step": "find_email_continue",  # Go back to AI
            "last_error": f"Previous selector '{selector}' failed: {error_msg}",
            "step_retry_count": retry_count + 1,
            "iteration_count": iteration + 1,
        }
    else:
        # Max retries reached, fail
        return {
            **state,
            "current_step": "failed",
            "error": f"Failed after 3 attempts: {error_msg}",
        }
```

### 2. CSS Context Integration

#### CSS Extraction

Created `extract_page_css()` function to scrape all CSS from page:

```python
async def extract_page_css(page: Page) -> str:
    """Extract all CSS from the current page including inline and external stylesheets."""
    try:
        css_content = await page.evaluate("""
            () => {
                let css = '';

                // Get all style tags
                const styleTags = document.querySelectorAll('style');
                styleTags.forEach((tag, index) => {
                    css += `\\n/* <style> tag ${index + 1} */\\n`;
                    css += tag.textContent + '\\n';
                });

                // Get all link stylesheets
                const linkTags = document.querySelectorAll('link[rel="stylesheet"]');
                linkTags.forEach((link, index) => {
                    css += `\\n/* Linked stylesheet ${index + 1}: ${link.href} */\\n`;
                    // Note: Can't access external CSS content due to CORS
                });

                // Get inline styles (sample first 10 elements)
                const elementsWithStyle = document.querySelectorAll('[style]');
                if (elementsWithStyle.length > 0) {
                    css += `\\n/* Inline styles found on ${elementsWithStyle.length} elements */\\n`;
                    Array.from(elementsWithStyle).slice(0, 10).forEach((el, index) => {
                        css += `${el.tagName.toLowerCase()}: ${el.getAttribute('style')}\\n`;
                    });
                }

                return css;
            }
        """)
        return css_content
    except Exception as e:
        print(f"‚ö†Ô∏è  Failed to extract CSS: {e}")
        return ""
```

#### State Updates

Added `current_css` field and updated all steps to capture CSS:

```python
# Get current state
current_dom = await page.content()
current_css = await extract_page_css(page)  # ‚Üê NEW
current_url = page.url

return {
    **state,
    "current_dom": current_dom,
    "current_css": current_css,  # ‚Üê NEW
    "current_page_url": current_url,
}
```

#### Prompt Enhancement

Updated all prompt functions to include CSS context:

```python
def get_find_email_continue_prompt(
    html_content: str,
    last_error: str | None = None,
    css_content: str | None = None  # ‚Üê NEW
) -> str:
    """Get prompt for finding email continue button."""
    error_note = ""
    if last_error:
        error_note = f"\n\n‚ö†Ô∏è IMPORTANT: {last_error}\n" \
                     "Please choose a DIFFERENT selector using standard CSS syntax.\n"

    css_note = ""
    if css_content:
        css_note = f"\n\nAvailable CSS classes and styles (first 3000 chars):\n" \
                   f"{css_content[:3000]}\n"

    return FIND_EMAIL_CONTINUE_PROMPT.format(html_content=html_content[:5000]) + \
           css_note + error_note
```

---

## Enhanced Prompts

### Explicit Selector Guidance

Updated `FIND_EMAIL_CONTINUE_PROMPT` to explicitly warn against jQuery selectors:

```python
FIND_EMAIL_CONTINUE_PROMPT = """You are analyzing a login page after email entry to find the Continue/Next button.

Many login forms have a two-step process: first enter email, then click Continue to proceed to password.

Analyze the HTML and identify the CSS selector for the Continue/Next button after email entry.

IMPORTANT: Use only standard CSS selectors. DO NOT use jQuery selectors like :contains(), :visible, etc.
Valid CSS selector types: element, .class, #id, [attribute], [attribute='value'], :nth-child(), etc.

Return ONLY a JSON object with this structure:
{{
    "selector": "CSS selector for the continue button",
    "confidence": "high/medium/low",
    "reasoning": "Brief explanation"
}}
...
"""
```

---

## Complete Workflow with Retry

### Example Session

```
============================================================
üîÑ Iteration 2/10 - Step: find_email_continue
============================================================

ü§ñ AI Analysis for step: find_email_continue
   Analyzing page to find email continue button...
   üì° Calling OpenAI API (gpt-4o-mini)...
   ‚úÖ Received response from OpenAI
   ‚úÖ Found continue selector: button:contains('Continue')
   Confidence: high
   Reasoning: Button with 'Continue' text

============================================================
üîÑ Iteration 3/10 - Step: click_email_continue
============================================================
üñ±Ô∏è  Clicking Continue button after email...
   Clicking continue button: button:contains('Continue')
‚ùå Click failed: SyntaxError: 'button:contains("Continue")' is not a valid selector
üîÑ Retrying... (attempt 1/3)

============================================================
üîÑ Iteration 4/10 - Step: find_email_continue
============================================================

ü§ñ AI Analysis for step: find_email_continue

‚ö†Ô∏è IMPORTANT: Previous selector 'button:contains('Continue')' failed: SyntaxError
Please choose a DIFFERENT selector that uses standard CSS syntax.

Available CSS classes:
.continue-btn { background: blue; color: white; }
.primary-button { ... }

   üì° Calling OpenAI API (gpt-4o-mini)...
   ‚úÖ Received response from OpenAI
   ‚úÖ Found continue selector: button.continue-btn
   Confidence: high
   Reasoning: Button with continue-btn class, standard CSS selector

============================================================
üîÑ Iteration 5/10 - Step: click_email_continue
============================================================
üñ±Ô∏è  Clicking Continue button after email...
   Clicking continue button: button.continue-btn
‚úÖ Continue button clicked using selector: button.continue-btn
‚è≥ Waiting 3 seconds...
```

---

## Code Changes Summary

### Files Modified

1. **`src/workflows/state.py`**
   - Added `last_error: str | None`
   - Added `step_retry_count: int`
   - Added `current_css: str | None`

2. **`src/workflows/nodes.py`**
   - Added `extract_page_css()` helper function
   - Updated `login_node()` to capture CSS at every step
   - Updated all action steps (enter_email, click_email_continue, enter_password, click_submit) with retry logic
   - Updated `openai_node()` to pass `current_css` to prompts

3. **`src/prompts/iterative_login_prompts.py`**
   - Updated all prompt functions to accept `css_content` parameter
   - Added CSS context to prompts (first 3000 chars)
   - Added explicit jQuery selector warnings
   - Enhanced error feedback integration

4. **`src/main.py`**
   - Initialized `last_error: None`
   - Initialized `step_retry_count: 0`
   - Initialized `current_css: None`

---

## Retry Logic Details

### Retry Count per Step

Each **step** gets up to 3 retry attempts:

- `find_email` ‚Üí `enter_email` (max 3 retries)
- `find_email_continue` ‚Üí `click_email_continue` (max 3 retries)
- `find_password` ‚Üí `enter_password` (max 3 retries)
- `find_submit` ‚Üí `click_submit` (max 3 retries)

Retry count **resets to 0** when moving to a new step successfully.

### Error Message Format

Error messages passed to OpenAI include:
1. The failed selector
2. The specific error reason
3. Instruction to choose a different selector

Example:
```
Previous selector 'button:contains('Continue')' failed:
SyntaxError: Failed to execute 'querySelectorAll' on 'Document':
'button:contains("Continue")' is not a valid selector.
```

### Fallback Strategy

For `enter_email` and `enter_password`, there's a special fallback:

1. Try `page.fill(selector, value)` (attempts 1-2)
2. If all retries fail, try keyboard typing as last resort (attempt 3)
3. Only fail if keyboard typing also fails

```python
if retry_count < 3:
    # Try with different selector from AI
    return go_back_to_ai_step
else:
    # Last resort: keyboard fallback
    try:
        await page.focus(selector, timeout=5000)
        await page.keyboard.type(state["email"])
    except Exception as e2:
        return fail_step
```

---

## CSS Context Benefits

### What CSS Information Provides

1. **Class Names**: `.continue-btn`, `.primary-button`, `.login-form`
2. **ID References**: Elements with IDs that might not be in HTML attributes
3. **Inline Styles**: `style="display: block"` attributes on elements
4. **Selector Patterns**: Common patterns like `.button.primary`
5. **External Stylesheet URLs**: Context about design system used

### Example CSS Context Sent to OpenAI

```css
/* <style> tag 1 */
.continue-btn {
    background-color: #0073ea;
    color: white;
    padding: 10px 20px;
}

.primary-button {
    font-weight: bold;
}

/* Linked stylesheet 1: https://example.com/styles.css */

/* Inline styles found on 5 elements */
button: display: block; margin: 10px auto;
div: background: #f5f5f5;
```

### Improved Selector Accuracy

**Without CSS context:**
- AI might suggest generic `button` selector
- May not know about `.continue-btn` class
- Could resort to text-based selectors like `:contains()`

**With CSS context:**
- AI sees `.continue-btn` class exists
- Can choose more specific selectors
- Understands page's class naming conventions
- Avoids invalid jQuery selectors

---

## Performance Metrics

### Token Usage Impact

**Before (Phase 1b):**
- ~5000 chars of HTML per prompt
- ~3,850 tokens per login

**After (Phase 1d):**
- ~5000 chars of HTML + ~3000 chars of CSS per prompt
- Estimated ~5,200 tokens per login (+35%)
- Still well within context limits
- **Worth the cost** due to higher success rate

### Success Rate Improvement

**Expected Improvements:**
1. **Retry on invalid selectors**: Catch jQuery selectors and retry
2. **CSS-aware selection**: More accurate class/ID targeting
3. **Reduced failures**: Up to 3 attempts per step vs. instant fail

**Estimated Success Rate:**
- Phase 1b: ~70% (one-shot, HTML only)
- Phase 1d: ~90%+ (retries + CSS context)

---

## Error Handling Flow

### Complete Error Flow

```
1. Action Attempt (click/fill)
   ‚Üì
2. Exception Caught
   ‚Üì
3. Check Retry Count
   ‚Üì
4a. Count < 3?
   ‚îú‚îÄ Yes ‚Üí Pass error to OpenAI
   ‚îÇ         ‚Üì
   ‚îÇ      OpenAI suggests new selector
   ‚îÇ         ‚Üì
   ‚îÇ      Increment retry_count
   ‚îÇ         ‚Üì
   ‚îÇ      Try again
   ‚îÇ
   ‚îî‚îÄ No ‚Üí Max retries exhausted
            ‚Üì
         Try fallback (if available)
            ‚Üì
         Fail with detailed error
```

### State Transitions on Retry

**Successful Action:**
```python
{
    "current_step": "find_password",  # Next step
    "step_retry_count": 0,            # Reset
    "last_error": None,               # Clear error
    "iteration_count": iteration + 1,
}
```

**Failed Action (Retry):**
```python
{
    "current_step": "find_email_continue",  # Back to AI
    "step_retry_count": retry_count + 1,    # Increment
    "last_error": "Previous selector '...' failed: ...",
    "iteration_count": iteration + 1,
}
```

**Failed Action (Max Retries):**
```python
{
    "current_step": "failed",
    "error": "Failed to click continue button after 3 attempts: ...",
}
```

---

## Testing & Validation

### Test Scenarios

1. **Invalid jQuery Selector**
   - OpenAI suggests `button:contains('Continue')`
   - System catches error, retries with valid CSS selector
   - ‚úÖ Should succeed on retry

2. **Element Not Found**
   - Selector valid but element doesn't exist
   - System retries with different selector
   - ‚úÖ Should find alternative element

3. **Timeout on Click**
   - Element exists but not clickable
   - System retries with different approach
   - ‚úÖ Should succeed or try alternative

4. **CSS Context Utilization**
   - Page has `.login-button` class in CSS
   - OpenAI should prefer `.login-button` over generic selectors
   - ‚úÖ Should use CSS-aware selectors

### Manual Testing

Run the login flow and observe:

```bash
uv run app
```

**Expected Output:**
- CSS extraction logs
- Retry messages when selectors fail
- OpenAI receiving error feedback
- Alternative selectors being tried
- Eventual success after retries

---

## Future Enhancements

### Potential Improvements

1. **Selector History Tracking**
   - Track all tried selectors to avoid repeating same failures
   - Pass entire history to OpenAI

2. **Computer Vision Fallback**
   - If CSS selectors fail, use vision model to identify button by appearance
   - Screenshot ‚Üí Vision API ‚Üí "Click at coordinates (x, y)"

3. **Adaptive Retry Limits**
   - Increase retry limit for critical steps
   - Decrease for less important steps

4. **CSS Preprocessing**
   - Filter CSS to only relevant classes/IDs
   - Reduce token usage while maintaining context

5. **Learning from Successes**
   - Cache successful selectors for similar pages
   - Build a knowledge base of working patterns

---

## Comparison: Phase 1b vs Phase 1d

| Feature | Phase 1b | Phase 1d |
|---------|----------|----------|
| **Retry on Failure** | ‚ùå Immediate fail | ‚úÖ Up to 3 retries per step |
| **Error Feedback** | ‚ùå No feedback | ‚úÖ Error passed to OpenAI |
| **CSS Context** | ‚ùå HTML only | ‚úÖ HTML + CSS |
| **jQuery Selectors** | ‚ö†Ô∏è Not handled | ‚úÖ Explicit warning + retry |
| **Selector Accuracy** | ~70% | ~90%+ (estimated) |
| **Token Usage** | ~3,850 tokens | ~5,200 tokens (+35%) |
| **Success Rate** | Medium | High |
| **Resilience** | Low (single attempt) | High (multiple attempts) |

---

## Key Takeaways

1. **Retry logic is essential** for robust AI-guided automation
2. **CSS context significantly improves** selector accuracy
3. **Error feedback loops** help AI learn and adapt
4. **Token cost increase is justified** by success rate improvement
5. **jQuery selector detection** prevents common OpenAI mistakes

---

## Related Documentation

- `docs/03.Phase1a.md` - Web scraping setup
- `docs/04.Phase1b.md` - AI-guided iterative login
- `docs/04.Phase1c.md` - Event loop fixes and environment configuration

---

## Summary

Phase 1d transforms the login system from **fragile** to **resilient**:

- ‚ùå Before: Single attempt ‚Üí fail on invalid selector
- ‚úÖ After: Retry with feedback ‚Üí learn from errors ‚Üí succeed

The combination of **retry logic** and **CSS context** creates a robust system that can handle edge cases, invalid selectors, and complex login flows with high reliability.

**Next Phase:** Phase 2 - Dashboard scraping after successful login
